{% extends 'admin/master.html' %} {% block head %} {{ super() }}
<script src="/static/jsroot/scripts/d3.min.js"></script>
<script src="/static/jsroot/scripts/JSRootCore.js"></script>
<script src="/static/jsroot/scripts/JSRootPainter.js"></script>
<script src="/static/jsroot/scripts/JSRootPainter.more.js"></script>
<script src="/static/js/rootana_functions.js" type="text/javascript"></script> {% endblock head %} {% with messages = get_flashed_messages() %} {% if messages %}
<ul class='flashes'>
	{% for message in messages %}
	<li>{{ message }}</li>{% endfor %}
</ul>
{% endif %} {% endwith %} {% block body %} {{ super() }} {% if not get_flashed_messages() %}
<script>
	gIsPaused = false;
	gModule = {{ modlist[0] }};
	gChannel = 0;
	gRefresh = 5;
	gIntervalID = 0;
	gJSONdata = undefined
	gURL = undefined

	window.addEventListener("load", init);

	function init() {
		do_refresh();
		gIntervalID = setInterval(ROOTplot, gRefresh * 1000);
	}

	function pause_resume() {
		if (gIsPaused) {
			gIsPaused = false;
			$('#pause_button span:last-child').text(" Pause");
			document.getElementById("icon01").classList.replace("glyphicon-play", "glyphicon-pause");
		} else {
			gIsPaused = true;
			$('#pause_button span:last-child').text(" Resume");
			document.getElementById("icon01").classList.replace("glyphicon-pause", "glyphicon-play");
		}
	}

	function select_channel() {
		$('#graphdiv').html(""); // reset histogram
		var e = document.getElementById("sel_module");
		gModule = e.options[e.selectedIndex].value;

		var e = document.getElementById("sel_channel");
		gChannel = e.options[e.selectedIndex].value;

		document.getElementById("module").innerHTML = gModule;
		document.getElementById("channel").innerHTML = gChannel;
		
		do_refresh();
	}

	function select_refresh() {
		var e = document.getElementById("sel_refresh");
		gRefresh = e.options[e.selectedIndex].value;

		document.getElementById("refresh").innerHTML = gRefresh;
		clearInterval(gIntervalID);
		gIntervalID = setInterval(do_refresh, gRefresh * 1000);
	}

	function do_refresh() {
		gURL = "http://localhost:5000/ma/" + gModule + "/" + gChannel;
		getUrl(gURL, undefined).then(function(response) {
			gJSONdata = JSON.parse(response);
		});

		ROOTplot();
		updatePVs();
	}

	function ROOTplot() {
		if (gIsPaused) {
			return;
		}
		histo = JSROOT.CreateTH1(25000);
		for (var i=0; i<gJSONdata.hvalues.length; i++) {
	   	histo.setBinContent(i, gJSONdata.hvalues[i]);
		}
		histo.fTitle = gJSONdata["htitle"];
		JSROOT.redraw('graphdiv', histo, "");
	}

	function updatePVs() {
		document.getElementById("cfdthreshold").innerHTML = gJSONdata.cfdthreshold;
	}

</script>

<div id="placeholder"></div>

<div class="container-fluid">
	<div class="row">
		<div class="col-lg-4">
			<div class="panel panel-default">
				<div class="panel-heading">Display control</div>
				<div class="panel-body">
					<div class="well well-sm">
						<button type="button" class="btn btn-primary" id="pause_button" onclick="pause_resume();">
							<span id="icon01" class="glyphicon glyphicon-pause"> Pause</span>
						</button>
					</div>
					<!-- end well -->
					<div class="well well-sm">
						<button type="button" class="btn btn-primary" id="reset_button">
							<span class="glyphicon glyphicon-refresh"> Reset histogram</span>
						</button>
					</div>
					<!-- end well -->
					<div class="well well-sm">
						<label for="sel_refresh">Refresh period:</label>
						<select class="form-control" id="sel_refresh" onclick="select_refresh();">
							<option value=1>1 second</option>
							<option value=2>2 seconds</option>
							<option value=5 selected>5 seconds</option>
						</select>
					</div>
					<!-- end well body-->
				</div>
				<!-- end panel body-->
			</div>
			<!-- end panel -->
			<div class="panel panel-default">
				<div class="panel-heading">Parameters</div>
				<div class="panel-body">
					<h5>
						<b>Module: </b>
						<span id="module">0</span>
					</h5>
					<h5>
						<b>Channel: </b>
						<span id="channel">0</span>
					</h5>
					<h5>
						<b>Plot refresh period: </b>
						<span id="refresh">5</span> s
					</h5>
					<h5>
						<b>CFD Threshold: </b>
						<span id="cfdthreshold">-</span> mV
					</h5>
				</div>
				<!-- end panel body-->
			</div>
			<!-- end panel -->
		</div>
		<!-- end col -->


		<div class="col-lg-8">
			<div class="panel panel-default">
				<div class="panel-heading">Megamp selection</div>
				<div class="panel-body">
					<div class="row">
						<div class="col-lg-4">
							<label for="sel_module">Module:</label>
							<select class="form-control" id="sel_module">
								{% for mod in modlist %}
								<option value={{ mod }}>{{ mod }}</option>
								{% endfor %}
							</select>
						</div>
						<!-- end col -->
						<div class="col-lg-4">
							<label for="sel_channel">Channel:</label>
							<select class="form-control" id="sel_channel">
								{% for ch in range(16) %}
								<option value={{ ch }}>{{ ch }}</option>
								{% endfor %}
							</select>
						</div>
						<!-- end col -->
						<div class="col-lg-4">
							<div class="row"></div>
							<label for="sel_module"></label>
							<button type="button" class="btn btn-success btn-block" id="submit_button" onclick="select_channel();">
								<span class="glyphicon glyphicon-ok"> OK</span>
							</button>
						</div>
						<!-- end col -->
					</div>
					<!-- end row -->
				</div>
				<!-- end panel body -->
			</div>
			<!-- end panel -->

			<div class="panel panel-default">
				<div class="panel-heading">Histogram</div>
				<div class="panel-body">
					<div id="graphdiv" style="width:800px; height:500px"></div>
				</div>
				<!-- end panel body -->
			</div>
			<!-- end panel -->

			<div class="col-lg-12">
				<div class="panel panel-default">
					<div class="panel-heading">Status</div>
					<div class="panel-body">
						<h5>
							<b>Last update: </b>
							<span id="datetime"></span>
						</h5>
						<h5>
							<b>Read back status: </b>
							<span id="readstatus"></span>
						</h5>
					</div>
					<!-- end panel body -->
				</div>
				<!-- end panel -->
			</div>
			<!-- end col -->
		</div>
		<!-- end col -->
	</div>
	<!-- end row -->
</div>
<!-- end container -->
</div>

{% endif %} {% endblock body %}