{% extends 'admin/master.html' %}

{% block head %}
{{ super() }}
<script src="/static/jsroot/scripts/d3.min.js"></script>
<script src="/static/jsroot/scripts/JSRootCore.js"></script>
<script src="/static/jsroot/scripts/JSRootPainter.js"></script>
<script src="/static/jsroot/scripts/JSRootPainter.more.js"></script>
<script src="/static/js/plotting_functions_jsroot.js?v=3" type="text/javascript"></script>
<script src="/static/js/rootana_functions.js" type="text/javascript"></script>
{% endblock head %}

{% with messages = get_flashed_messages() %}
   {% if messages %}
      <ul class='flashes'>
         {% for message in messages %}<li>{{ message }}</li>{% endfor %}
      </ul>
   {% endif %}
{% endwith %}

{% block body %}
{{ super() }}
{# if rcs == 0 and modlist|length > 1 #}
{% if rcs == 0 %}
   <script>
      gIsPaused = false;
      gModule = 0;
      gChannel = 0;
      gRefresh = 5;
      gIntervalID = 0;

      window.addEventListener("load", init);
      
      function init() {
         ROOTplot();
         gIntervalID = setInterval(ROOTplot, gRefresh * 1000);
      }
      
      function pause_resume() {
         if(gIsPaused) {
            gIsPaused = false;
            $('#pause_button span:last-child').text(" Pause");
            document.getElementById("icon01").classList.replace("glyphicon-play", "glyphicon-pause");
         } else {
            gIsPaused = true;
            $('#pause_button span:last-child').text(" Resume");
            document.getElementById("icon01").classList.replace("glyphicon-pause", "glyphicon-play");
         }
      }

      function select_channel() {
         $('#graphdiv').html(""); // reset histogram
         var e = document.getElementById("sel_module");
         gModule = e.options[e.selectedIndex].value;
         
         var e = document.getElementById("sel_channel");
         gChannel = e.options[e.selectedIndex].value;

         document.getElementById("module").innerHTML = gModule;
         document.getElementById("channel").innerHTML = gChannel;
         ROOTplot(); // plot histogram
      }

      function select_refresh() {
         var e = document.getElementById("sel_refresh");
         gRefresh = e.options[e.selectedIndex].value;

         document.getElementById("refresh").innerHTML = gRefresh;
         clearInterval(gIntervalID);
         gIntervalID = setInterval(ROOTplot, gRefresh * 1000);
         console.log(gRefresh);
      }
   
      function ROOTplot() {
         if(gIsPaused) {
            return;
			}
			url = "http://localhost:5000/hist/" + gModule + "/" + gChannel;
         plotHistogramJSROOT("graphdiv", url)
         document.getElementById("datetime").innerHTML = Date();
      }
      
   </script>

<div id="placeholder"></div>

<div class="container-fluid">
   <div class="row">
      <div class="col-lg-4">
         <div class="panel panel-default">
            <div class="panel-heading">Display control</div>
            <div class="panel-body">
               <div class="well well-sm">
                  <button type="button" class="btn btn-primary" id="pause_button" onclick="pause_resume();">
                     <span id="icon01" class="glyphicon glyphicon-pause"> Pause</span>
                  </button>
               </div>
               <div class="well well-sm">
                  <button type="button" class="btn btn-primary" id="reset_button">
                     <span class="glyphicon glyphicon-refresh"> Reset histogram</span>
                  </button>
               </div>
               <div class="well well-sm">
                  <label for="sel_refresh">Refresh period:</label>
                  <select class="form-control" id="sel_refresh" onclick="select_refresh();">
                        <option value=1>1 second</option>
                        <option value=2>2 seconds</option>
                        <option value=5 selected>5 seconds</option>
                  </select>
               </div>
            </div>  
         </div>  

         <div class="panel panel-default">
            <div class="panel-heading">Megamp selection</div>
            <div class="panel-body">
               <div class="well well-sm">
                  <label for="sel_module">Module:</label>
                  <select class="form-control" id="sel_module">
                        {% for mod in modlist %}
                              <option value={{ mod }}>{{ mod }}</option>
                        {% endfor %}
                  </select>
               </div>
               <div class="well well-sm">
                  <label for="sel_channel">Channel:</label>
                  <select class="form-control" id="sel_channel">
                     {% for ch in range(16) %}
                        <option value={{ ch }}>{{ ch }}</option>
                     {% endfor %}
                  </select>
               </div>
               <button type="button" class="btn btn-success btn-block" id="submit_button" onclick="select_channel();">
                        <span class="glyphicon glyphicon-ok"> OK</span>
                     </button>
            </div>
            </div>  
      </div>
      <div class="col-lg-8">
         <div id="graphdiv" style="width:800px; height:500px"></div>
         <div class="row">
				<div class="col-lg-4">
            	<div class="panel panel-default">
            	   <div class="panel-heading">Parameters</div>
            	   <div class="panel-body">
            	      <h5><b>Module: </b><span id="module">0</span></h4>
            	      <h5><b>Channel: </b><span id="channel">0</span></h4>
            	      <h5><b>Plot refresh period: </b><span id="refresh">5</span>s</h5>
            	   </div>
					</div>
				</div>
				<div class="col-lg-8">
						<div class="panel panel-default">
							<div class="panel-heading">Status</div>
							<div class="panel-body">
								<h5><b>Last update: </b><span id="datetime"></span></h5>
								<h5><b>Read back status: </b><span id="readstatus"></span></h5>
							</div>
						</div>
				</div>
         </div>
      </div>
   </div>

</div>

{% endif %}
{% endblock body %}